%% ==============================================================================
%% Failure Propagation Diagram
%% ==============================================================================
%% Source File:     specs/system/failure-modes.md
%% Repository Path: diagrams/system/failure/system-failure-propagation.png
%% Description:     Visualizes how failures in one subsystem (e.g., Execution,
%%                  Governance) propagate to others (Monitoring, Cognition,
%%                  Evolution), triggering blocks, rejections, or evolution.
%% ==============================================================================

graph TD
    %% Global Styles
    classDef layer fill:#f5f5f5,stroke:#616161,stroke-width:2px,color:#000;
    classDef fail fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000;
    classDef effect fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000;
    classDef crit fill:#d50000,stroke:#b71c1c,stroke-width:3px,color:#fff;
    classDef gov fill:#fbe9e7,stroke:#bf360c,stroke-width:2px,stroke-dasharray: 5 5,color:#000;
    classDef evo fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#000;

    %% 1. Execution Failure Propagation
    subgraph "Path 1: Execution → Monitoring → Governance"
        direction TB
        ActFail[Actuator Failure]:::fail
        Anom[Anomaly Detected]:::effect
        Block[Action Blocked]:::gov
        
        ActFail -->|Physical Error| Anom
        Anom -->|Safety Violation| Block
    end

    %% 2. Cognitive Failure Propagation
    subgraph "Path 2: Cognitive Core → Execution"
        direction TB
        PlanInv[Invalid Plan]:::fail
        Reject[Execution Reject]:::effect
        Retry[Re-Reasoning]:::effect
        
        PlanInv -->|Unsafe Codons| Reject
        Reject -->|Feedback| Retry
    end

    %% 3. Monitoring Failure Propagation
    subgraph "Path 3: Monitoring → Evolution"
        direction TB
        Repeated[Repeated Anomalies]:::fail
        Pattern[Failure Pattern]:::effect
        Trigger[Evolution Trigger]:::evo
        
        Repeated -->|Accumulation| Pattern
        Pattern -->|Threshold Met| Trigger
    end

    %% 4. Governance Failure Propagation (Critical)
    subgraph "Path 4: Governance → All Layers"
        direction TB
        PolFail[Policy Mismatch / Timeout]:::fail
        Halt((System Halt)):::crit
        
        PolFail -->|Authority Lost| Halt
    end

    %% Cross-Layer Impact of System Halt
    Halt -.->|Stop| ActFail
    Halt -.->|Freeze| PlanInv
    Halt -.->|Suspend| Repeated

    %% Annotations
    note1["Propagation must be detected early
            to prevent cascading system collapse"]:::effect -.-> Anom
