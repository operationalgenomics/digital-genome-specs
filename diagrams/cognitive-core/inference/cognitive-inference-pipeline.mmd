%% ==============================================================================
%% Inference Pipeline Diagram
%% ==============================================================================
%% Source File:     specs/cognitive-core/inference-engine.md
%% Repository Path: diagrams/cognitive-core/inference/cognitive-inference-pipeline.png
%% Description:     Visualizes the sequential inference pipeline: Intent/Context
%%                  Prep -> Safety Filter -> Governance Filter -> Applicability
%%                  Check -> Predictive Simulation -> Ranking -> Selection.
%% ==============================================================================

graph TD
    %% Global Styles
    classDef input fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000;
    classDef proc fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000;
    classDef check fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#000;
    classDef action fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000;
    classDef reject fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000;

    %% 1. Preparation Phase
    subgraph "1. Interpretation & Normalization"
        direction TB
        RawIntent[HighLevelIntent]:::input
        RawContext[ContextSnapshot]:::input
        
        IntProc[Intent Interpreter]:::proc
        CtxNorm[Context Normalizer]:::proc
        
        RawIntent --> IntProc
        RawContext --> CtxNorm
    end

    %% 2. Filtering Phase (The Funnel)
    subgraph "2. Exclusion Layers"
        direction TB
        Safe{Safety Filter}:::check
        Gov{Governance Filter}:::check
        App{Applicability Engine}:::check
        
        IntProc & CtxNorm --> Safe
        
        Safe -->|Pass| Gov
        Safe -->|Violates Invariant| RejSafe[Reject: Safety Risk]:::reject
        
        Gov -->|Pass| App
        Gov -->|Forbidden| RejGov[Reject: Policy]:::reject
        
        App -->|Valid| Set[Applicability Set]:::action
        App -->|Invalid Context| RejApp[Discard: Mismatch]:::reject
    end

    %% 3. Evaluation Phase
    subgraph "3. Predictive Evaluation"
        direction TB
        Sim[Predictive Simulation]:::proc
        Rank[Ranking Engine]:::proc
        
        Set --> Sim
        Sim -->|Predicted Outcomes| Rank
    end

    %% 4. Selection Phase
    subgraph "4. Final Decision"
        direction TB
        Select{Selection Engine}:::action
        Result[Selected Gene]:::action
        Trace[Rationale Trace]:::input
        
        Rank -->|Scored Candidates| Select
        Select -->|Best Score| Result
        Select -->|Explain| Trace
    end

    %% Scoring Logic Annotation
    note1["Scoring Weights:\nSafety > Governance > Fit > Intent"]:::proc -.-> Rank
